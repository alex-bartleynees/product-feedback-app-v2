# Cache zone
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATIC:10m inactive=7d use_temp_path=off;

# WebSocket support (only sets Connection header when needed)
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

# stream to container-nodejs
upstream nodejs {
  server nodejs:4000;
  keepalive 32;
}

upstream api {
  server product-feedback-bff:5224;
  keepalive 32;
}

server {
  listen 80 default_server;
  http2 on;

  server_name _;

  server_tokens off;

  # Increase buffer sizes for large client request headers/cookies
  client_header_buffer_size 16k;
  large_client_header_buffers 4 32k;

  gzip on;
  gzip_proxied any;
  gzip_comp_level 4;
  gzip_types text/css application/javascript image/svg+xml;

  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection $connection_upgrade;
  proxy_cache_bypass $http_upgrade;

  # Increase buffer sizes for large headers (needed for auth cookies)
  proxy_buffer_size 16k;
  proxy_buffers 8 16k;
  proxy_busy_buffers_size 32k;

  location /assets {
    proxy_cache STATIC;
    proxy_ignore_headers Cache-Control;
    proxy_cache_valid 60m;
    proxy_pass http://nodejs;
  }

  location /media {
    proxy_cache STATIC;
    proxy_ignore_headers Cache-Control;
    proxy_cache_valid 60m;
    proxy_pass http://nodejs;
  }

location ~ ^/(chunk|styles) {
    proxy_cache STATIC;
    proxy_ignore_headers Cache-Control;
    proxy_cache_valid 60m;
    proxy_pass http://nodejs;
}

  location /favicon.ico {
    proxy_cache STATIC;
    proxy_ignore_headers Cache-Control;
    proxy_cache_valid 60m;
    proxy_pass http://nodejs;
  }

  location /api {
    proxy_pass http://api;

          # Forward original host and IP
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;

          # Keep-alive connections
          proxy_set_header Connection "";
          proxy_http_version 1.1;

          # Important: Pass cookies to BFF (for authentication)
          proxy_set_header Cookie $http_cookie;
          proxy_pass_header Set-Cookie;

          # Disable buffering for real-time responses
          proxy_buffering off;

          # Timeouts
          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;
  }

  location /bff {
      proxy_pass http://api;

          # Forward original host and IP
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;

          # Keep-alive connections
          proxy_set_header Connection "";
          proxy_http_version 1.1;

          # Important: Pass cookies to BFF (for authentication)
          proxy_set_header Cookie $http_cookie;
          proxy_pass_header Set-Cookie;

          # Disable buffering for real-time responses
          proxy_buffering off;

          # Timeouts
          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;
  }

  location /signin-oidc {
      proxy_pass http://api;

          # Forward original host and IP
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;

          # Keep-alive connections
          proxy_set_header Connection "";
          proxy_http_version 1.1;

          # Important: Pass cookies to BFF (for authentication)
          proxy_set_header Cookie $http_cookie;
          proxy_pass_header Set-Cookie;

          # Disable buffering for real-time responses
          proxy_buffering off;

          # Timeouts
          proxy_connect_timeout 60s;
          proxy_send_timeout 60s;
          proxy_read_timeout 60s;
  }

  # DYNAMIC ASSETS - NO CACHE
  location / {
    proxy_pass http://nodejs;
  }
}
